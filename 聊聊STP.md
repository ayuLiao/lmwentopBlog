---
title: 聊聊STP
date: 2016-09-05 23:36:30
tags: 网络协议
---

## STP是什么？
STP：生成树协议，用于交换网络，防止环路的形成！
二层交换机因为不能隔离广播域，所以不能让二层网络形成环路，如果形成的环路，则会引起广播风暴和地址学习错误，为了防止交换机成环后防止广播与地址学习错误，就有了STP

## STP生效原理
STP允许交换机的物理存在环路，但是，**它在逻辑上会有一个阻塞端口，这样就防止了链路的环路，**如果SW3的正常端口发生故障，阻塞状态的端口就会变成转发状态，激活冗余链路
![物理成环](http://obfs4iize.bkt.clouddn.com/%E6%88%90%E7%8E%AF%E9%93%BE%E8%B7%AF.png)

## 第一步：确认环路中的根桥
STP的第一步就是确认环路中的根桥，根据各台交换机的BID来选择，具备最小BID的交换机会成为根桥，BID有交换机的交换机优先级+交换机的MAC地址组成，**默认情况，所有交换机的优先级都是相同的，**所以比较BID，因为优先级相同，变成比较交换机的MAC，所有关键MAC地址的大小决定根桥，具有最小MAC的交换机被选为根桥

```
	S1# show spanning-tree  //查看交换机的BID
```

交换机之间用BPDU(桥接协议报文单元)来进行BID信息交换

## 第二步：确认根端口
根桥选举完成后，就要选举出根端口了，所谓的根端口一定不在根桥上，而是**处于非根桥上**，同时指示到根桥的最小开销路径，交换机通过比较端口到根桥的路径开销，该**交换机的哪个端口到根桥的开销最小，那么选择该端口为根端口**，根端口将处于转发状态，用于转发数据包。

## 第三步：确定指派端口和阻端口
选举完根端口后，就开始选举指派端口和阻塞端口，指派端口将被设置为转发状态，通常根桥上的所有端口都可以理解为指派端口，处于转发状态，如果选择指派端口和阻塞端口？**交换机之间通过BPDU消息来比较BID，BID小的成为指派端口，剩余的为阻塞端口**，阻塞端口不能转发任何BPDU消息，这样就防止了环路的产生。

## 命令直接指定根桥
命令如下：
```
	SW1(config)# spanning-tree vlan 1 root [primary/secondary]
```
primary:将SW1配置成主根桥，SW1的优先级会发生改变
secondary:将SW1配置成辅助根桥，**当主根桥发生故障时，辅助根桥可以立即成为环路中的根桥**，辅助根桥的交换机的优先级比当前的主根桥的优先级高，但比其他交换机的优先级低


通过命令
```	
	SW1# show spanning-tree
```
看其中的Port path cost *,这个就是这个端口的开销，将该端口到根桥的路径上的端口的开销全部相加（出根桥本身的端口），就是该端口到根桥路径的开销，通过比较这个开销，来选举阻塞端口，而已通过命令来修改STP协议下的开销
```
	SW1(config)# int F0/1
	SW1(config-if)# spanning-tree cost 39	修改STP开销，干预阻塞端口选举
```

## 禁用STP
思科交换机的STP是默认开启的。
思科交换机默认启动的是PVST+的生成树，PVST+为每个VLAN生成一个生成树实例
禁用STP功能
```
 SW1(config)# no spanning-tree vlan 1	如果没有规划VLAN，就只有VLAN 1
```

## PID
PID，端口ID，由端口优先级加上端口编号组成，**默认情况下，端口优先级为128，所以拥有较小端口编号的交换机端口将具有更小PID**
通过命令来改变端口的PID
```
	SW1(config)# int F0/1
	SW1(config-if)#spanning-tree port-priority 124 改变端口的优先级，必须是4的倍数来改变端口优先级，124是4的倍数
```

选择阻塞端口时，**如果交换机所有端口到达根桥的路径开销都相同，那么就要比较PID了**，PID小的被设置为转发状态，也就是PID最大的为阻塞端口

## BPDU
BPDU是网桥协议数据单元，是一种生成树协议问候数据包，BPDU中包含了生成树选举的重要信息，如BID、路径开销、端口开销，它以间隔周期发送，用来在交换机之间进行信息交换。

BPDU的重要结构：
1.标记：BPDU有两种状态，TC消息和TCA消息，TC(Topology CHange 拓扑改变)消息表示拓扑发送了变化，TCA(Topology Change ACK 拓扑改变确认)消息表示收到了拓扑变化的消息，这两种消息，一个置为1，那么另一个就为0

2.根ID：表示根交换机的BID

3.最大生存时间：BPDU最大生存时间，当网络环境发送变化时，非根桥会立即停止向外发送BPDU，大约会停20s，这就是BPDU最大生存时间，20s内非根桥会认为该BPDU失效，过了20s，该BPDU会被视为无效

4.Hello时间：BPDU消息间隔时间，也就是BPDU发送周期，一般2s

5.转发延迟：侦听与学习过程中所花费的时间

## 生成树收敛时的端口状态

Down禁用：没有接网，或没有no shutdown时，端口的状态
Blocking阻塞：端口激活后，首先进入阻塞状态，可以接受BPDU报文，不能发送BPDU报文和数据通信，维持20s作用
Listening侦听：可以接受和发送BPDU，比参与STP的计算，会维持15s
Learning学习：交换机开始学习MAC，约维持15s，该状态下，交换机不能发送正常的通信数据
Forwarding转发：转发正常通信

STP基础就这些，后面的博文会继续聊聊STP的更多内容
