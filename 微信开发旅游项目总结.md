---
title: 微信开发旅游项目总结
date: 2017-05-18 09:33:19
tags: 随笔
---

## 简介
最近这个月很少更新，首要原因是我懒，其次接了一些项目，而且在抽空写python的书籍，没有以前慢有空，但是以后还是会监督自己让自己保持更新频率，让自己输出倒逼输入。

这次因为项目的原因，我又重回了PHP的怀抱，拍黄片（PHP）感觉真的简单好用，没有Python那么多语法糖，没有JAVA那么繁杂，我爱PHP又深了一层，虽然现在php依旧半桶水。（当然现在我还是最爱Python）

这次项目是在一个微信服务号上开发旅游功能，前端包括一个首页、一个景点详情页、购票成功界面和个人中心，后端包括旅游景点添加、购票流程、退票流程和锁票操作

先来看一下项目准备上线前的截图，直观的感受一下，图片是长截图的

这是项目的首页
![首页](http://obfs4iize.bkt.clouddn.com/%E6%97%85%E6%B8%B8%E9%A1%B9%E7%9B%AE%E9%A6%96%E9%A1%B5.jpg)

景点详情页，可以看旅游团要注意的事项和显示票种，这个界面是我负责的
![景点详情页](http://obfs4iize.bkt.clouddn.com/%E6%97%85%E6%B8%B8%E9%A1%B9%E7%9B%AE%E6%99%AF%E7%82%B9%E8%AF%A6%E6%83%85.jpg)

从景点详情页点击购票就会来到支付界面，支付完成后就会显示购票界面，旅游团会通过ID号来进行验票，然后就会有验票成功出现
![旅游项目购票.jpg](http://obfs4iize.bkt.clouddn.com/%E6%97%85%E6%B8%B8%E9%A1%B9%E7%9B%AE%E8%B4%AD%E7%A5%A8.jpg)

然后就是后端内容列表页，其实后台还有比较多的功能，因为不是我负责的，所以也只是有一定的了解，就不详细讲了
![内容列表](http://obfs4iize.bkt.clouddn.com/%E6%97%85%E6%B8%B8%E9%A1%B9%E7%9B%AE%E5%90%8E%E5%8F%B0.png)

## 框架介绍
一开始要接触微信开发，脑中第一个问题就是，微信服务器如何跟我们的服务器进行交互？有点概念的人应该都知道，用户使用微信，然后浏览公众号这些交互数据是给微信的服务器的，我们不可能将自己的业务逻辑代码部署到微信的服务器上，所以肯定要有一个自己的服务器用于部署我们的逻辑，那么就会有我刚刚的问题，两个服务器是怎么进行交互的，应该是有个规范的（微信服务器肯定不会跟任何一个服务器进行交互），所以对这个项目，我有点虚，因为这点没有想通，但是后来知道了，这个微信开发的项目是使用微擎的，微擎是一个第三方的PHP框架，主要就是用于微信开发的，这个框架帮助我们实现了一些常用的基础功能，也帮我们实现了与公众号进行交互的能力

但是上手微擎比较蛋疼，因为微擎的官方文档非常的少，很多东西都没有，以至于一开始我入手比较尴尬，有些功能我没有什么实现想法，微擎还有部分文档发布在看云，跟客服聊时，说看云的文档是最新，论坛里的文档已经不维护了.....

微擎在看云上文档的URL [http://www.kancloud.cn/donknap/we7/136556](微擎)

当然看云上的文档也不是特别友好，但是看官方文档还是学习一个新框架好方式，看完官方文档，你就会对框架有个整体把握，微擎这里要注意的就是数据库、模板和路由那几块，都封装成相应的方法了，还是对于不付费的东西，不能要求太多，毕竟人家这个框架又没收钱。

因为微擎的文档并不是细致，所以看完文档对框架的掌握还是没到可以独立开发的地步，这是可以看一些视频，还是原来的方法，下载到本地加速播放来看，然后就是读源码了，其实微擎的源码不会非常复杂，而且不要从头看到尾，重点看function文件夹下的，很多框架都会将一些常用方法放在一起，看一下这些封装好的方法是用于做什么的，因为有些方法文档里是没有提及的，看源码还可以学习框架的实现方式

微擎的论坛也不是十分活跃，很多都是2~3年前的帖子，但是框架还是在更新的。这个框架其他人可以帮你的真的不多（活跃度不高），这也是后面我开发遇到问题后查无可查的无奈！

讲一下使用微擎的好处，不用重头开始，很多基础问题完全手动实现还是很费力的，如权限监测、登录注册、公众号绑定、公众号的一些基础管理功能，这些微擎里都已经搞定了，你只需要在服务号或者公众号下配置APP ID和APP Secret，然后跟微擎绑定，微擎所在的服务器就可以跟微信服务器进行数据交互了，而且可以添加扩展，也即是其他人开发的一些模块功能，直接引入使用，非常方便！

下面讲一些些我开发中遇到的一些具体困难

## 后端界面显示
在编写添加旅游团信息的后端界面时，遇到了一些困难，如要动态添加富文本框，因为富文本框的添加可以通过微擎封装好的方法直接添加，那么一开始我就是通过js来判断，用户如果点击了添加富文本框的按钮，js就会调用这个方法，但是这样是行不通的，首先声明一下，这个界面对应的文件是goods_basic.html文件，是html结尾的静态文件，通过框架的模板功能，可以在html中插入php，框架会先解释其中的php，输出这些php对应的内容，然后在加载html和js，所以如果直接调用微擎生成富文本的方法，就会界面加载时直接执行，这样想通过js控制其动态显示富文本的功能就无法实现。

既然无法直接调用封装好的方法来实现，那我就去看了该方法的实现代码，发现其实也是js，没错，微擎框架将实现富文本的js通过php做了一些控制，然后封装成一个php方法，那我直接将这些js抽出来，放在goods_basic.html这个文件的js中，封装成一个点击事件才会触发的方法不就可以实现动态添加富文本框了嘛，然后我将其中的js都抽取出来，如果直接从框架源码中抽取还要处理该方法通过php对js做的一些控制，比较麻烦，一个取巧的方法就是通过浏览器查看源代码的方式，你会发现富文本的js代码工整的显示在你的面前，你直接选取下来用就好了

![富文本js](http://obfs4iize.bkt.clouddn.com/%E5%AF%8C%E6%96%87%E6%9C%ACjs.png)

你仔细看了这段代码就会知道，这段js就将一个textarea变成了一个富文本框，所以直接将动态这一长段js就可以了
![富文本2](http://obfs4iize.bkt.clouddn.com/%E5%AF%8C%E6%96%87%E6%9C%AC%E6%A1%862.png)

很遗憾，还是直接显示，接着google了一些富文本框js实现才明白了其中的原理，上面那长段js其实只有最后的function有用，该function前面的js代码都是对富文本框的属性设置，这些代码没有必要重复使用。

![富文本3](http://obfs4iize.bkt.clouddn.com/%E5%AF%8C%E6%96%87%E6%9C%AC%E6%A1%863.png)

细看这个function，其实就是对相应id的textarea进行初始化，我们只需js动态插入textarea，然后在调用该方法初始化一下就实现了动态插入富文本框的目的，还需要注意的是，**要先将textarea动态添加到html后，再调用该function进行初始化**

show一下相关代码
```js
function addOption(dd,cenname) {
	pp=pp+1;
	if(cenname == null || cenname == undefined || cenname == ""){
		cenname = '景点介绍';
	}
	document.getElementById('cententnum').value=pp+"";
	var centent = 'centent'+pp;
	var centent_name = centent + 'content_name';
	// centent1content_nameinput
	var centent_nameinput = centent + 'content_nameinput';
	var html = '<div class="form-group">'+
		'<label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span><span name="'+centent_name+'" id="'+centent_name+'">'+cenname+'</span>&nbsp;&nbsp;<a data-toggle="modal" data-target="#a" title="编辑"><i class="fa fa-pencil" onclick="getcontentname(\''+centent_name+'\')"></i></a>&nbsp;&nbsp;</label>'+
		'<input type="hidden" name="'+centent_nameinput+'" id="'+centent_nameinput+'" value="'+cenname+'"/>'+
		'<div class="col-sm-8 col-xs-12 col-md-9">'+
		 '<textarea id="'+centent+'" name="'+centent+'" type="text/plain" style="height:200px;">'+dd+'</textarea>'+
		'</div>'+'<div class="col-md-offset-2"><a href="javascript:;" onclick="deleteOption(this)" class="fa fa-times-circle " title="删除此操作">删除景点介绍</a></div>'+
	'</div>';
	// 先添加textarea到html中
	$('#travel-guide').append(html);
	// 再调用function方法进行初始化，注意textarea的id要唯一
		$(function(){
			var ue = UE.getEditor(centent, ueditoroption);
			$('#'+centent).data('editor', ue);
			$('#'+centent).parents('form').submit(function() {
				if (ue.queryCommandState('source')) {
					ue.execCommand('source');
				}
			});
		});
}
```

看一下完成后的效果图
![多个富文本框](http://obfs4iize.bkt.clouddn.com/%E5%A4%9A%E4%B8%AA%E5%AF%8C%E6%96%87%E6%9C%AC%E6%A1%86.png)

同性质的问题还有动态添加时间选择器，一个是可以选择一个时间范围的选择器另一个是只可选择具体日期和时间的选择器，这两个东西，微擎同样封装好了对应的php方法，去看这两个方法对应的源码，发现也是js和html，这里就没有富文本那么多事了，将相应的js和html抽离出来，放到goods_basic.html中，然后动态添加这些代码就可以了

![时间选择器](http://obfs4iize.bkt.clouddn.com/%E6%97%B6%E9%97%B4%E9%80%89%E6%8B%A9%E5%99%A8.png)

## 前端经验
前端的开发没有遇到什么大的问题，比较复杂的功能都已经有相应的js帮你搞定了，如日期选择就有相应的js了，我就将布局修改一下，这里主要是AJAX请求有点意思，这里讲讲AJAX

AJAX主要用于界面的局部更新的，目的是减少加载流量的，如果直接用AJAX来加载一整个界面，虽然可以实现，但是就事情了其意义，我们一般通过AJAX加载一下数据，然后动态添加到当前界面上，使用jQuery来实现AJAX显得非常简单，轻松几句话就搞定了，一开始没怎么弄过AJAX还有点慌的我，现在一看，贼简单

具体的用法可以去w3School上看，我常用的AJAX方法就那3个jQuery.ajax()、.load()、jQuery.post()

![AJAX使用.png](http://obfs4iize.bkt.clouddn.com/AJAX%E4%BD%BF%E7%94%A8.png)

AJAX要注意的就两点，一个是响应该AJAX方法的URL要写对，另一个就是响应该AJAX的php方法中不要使用ver_dump()方法来输出数据流，该方法会添加一下你不需要的内容到字符流中，所以使用echo最好，写AJAX时最好一步步来，首先响应方法中看看有没有接收到前端AJAX要传递的值，如使用$_POST['name']这个魔术方法，然后前端可以通过浏览器的命令行的NetWork选项卡来看一下AJAX请求有没有返回成功、返回的数据是什么

![AJAX返回内容.png](http://obfs4iize.bkt.clouddn.com/AJAX%E8%BF%94%E5%9B%9E%E5%86%85%E5%AE%B9.png)

还有前端出现错误时，没有必要立刻回去看代码，同样可以通过浏览器的命令行来看看具体错在哪里，有多少个错误，是不是js文件或css文件没有导入成功导致的，然后有了具体的想法再去改具体的代码，当然通过css微调界面布局时，为了可以实时看到对应的效果，最好也直接在浏览器命令行下修改，修改的内容虽然不会保存下来，但是可以看到css代码具体的效果，当达到我们预期效果时，再将代码拷贝到真正的css文件中

![修改css.png](http://obfs4iize.bkt.clouddn.com/%E4%BF%AE%E6%94%B9css.png)

## 经验总结
开始开发时，要强调一下团队意识，不然很多时候会有一些个人的习惯，同时需求分析要做好，开发人员不仅对自己负责开发的模块要有正确的理解，对他人负责的模块也要有正确的理解，因为很少有模块是完全独立的，大部分模块都需要相互传值，如我负责的购票界面要将票价和用户微信的id传递给创建购票订单的模块，当一开始没有比较全面的掌握时，很难做到很好的配合，到后期，要将代码修改来修改去的，非常麻烦，只有对整个项目有个整体的理解，而不是片面的理解某个局部，才可以提高配合效率，同时写一下接口文档，如我的模块需要从哪个模块获得什么形式的内容，通过石墨文档来写，可以同步协作，同步修改，当有了一个文档后，模块之间的交互会变得清晰，编写代码也有了个方向

对需求的理解很重要，要如果理解错了就非常惨烈了，你很可能要改很多东西，旅游项目中，比较难理解的就是客运站和票种之间的问题，通过我们这个平台可以购买到不同客运站的票，但是你并不一定要从那个客运站出发，这里涉及到了利润如何分成，如不是我的票，乘客却从我这上车，我这个客运站要收一定的费用，而售票的客运站也要收一定的费用等等，总之要记住，如果对需求理解有点模糊，就要立刻跟开发组的其他成员进行交流，或者直接跟需求方交流，避免从头错到尾，但是如果遇到开发上的问题，也就是代码问题，我建议是能不问就不问，要锻炼自己解决问题的能力，尽力了，实在没办法解决了，开始绝望了，再问一下前辈，当然这是时间不是非常紧的情况下，如果时间非常紧，也还是要尝试自己解决一下再提问，这里有一个观念，太弱智的问题，影响他人的效率和心情，我就比较讨厌天天问低级问题的人，分明直接百度或Google就可以找到解决方法了，偏偏跑来问，人家还要看你的问题，还要看你的代码，其实浪费了大家的时间！

用代码创造乐趣---ayuliao
