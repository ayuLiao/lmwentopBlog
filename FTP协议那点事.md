---
title: FTP协议那点事
date: 2016-07-16 09:17:24
tags: 网络协议
---

## 简介
FTP（File Transfer Protocol）文件传输协议，用于上传和下载文件，FTP使用两个端口进行工作，一个21端口，用于发送和接受**FTP控制信息**，一个20端口，用于发送和接收**数据流量**

FTP有两种不同的工作模式：**主动模式**和**被动模式**

## 主动模式
主动模式FTP经过两次TCP三次握手完成，数据最终在20号端口进行传输
这两次三次握手，一次是由FTP客户端主动发起到FTP服务器的连接，FTP客户端用大于或等于1024的源端口对FTP服务器21端口发起连接，**然后，有FTP服务器主动发起连接到FTP客户端，FTP服务器用20号端口主动向客户端1025号端口发起连接**

这是服务器**主动**向客户端发起连接，我用绘图工具简单画了一下，方便理解

![FTP主动模式](http://obfs4iize.bkt.clouddn.com/FTP.png)
可以看出，两次TCP握手分别是FTP客户端连接FTP服务器21端口和FTP服务器**主动连接**FTP客户端

## 被动模式
被动模式依旧要经过两次TCP三次握手完成，在被动模式中，FTP服务器只用了21端口

看看被动模式的过程：
首先，FTP客户端会用一个大于或等于1024的端为源端口与FTP服务器的21端口进行TCP三次握手
注意，**这次三次握手是FTP客户端发起的**
然后FTP服务器会尝试**告诉FTP客户端，小爷（FTP服务器本身）可以使用1034端口来进行数据传输**，如下图所示，要理解的是，FTP服务器将自己可以通过1034端口来传输数据的这个消息会话依旧属于**FTP客户端通过1024向FTP服务器21端口建立连接的一部分**，也就是说，属于第一次建立连接的部分
FTP服务器告诉FTP客户端的这个消息的源端口是FTP服务器的21端口，目标端口是FTP客户端的1024端口，这个消息帧相当于声明这是FTP被动模式
此时，FTP客户端收到这个消息帧，用大于或等于1024的端口（1024已经使用了）来与FTP服务器的1034端口进行通信
这样你会发现**FTP服务器不会想主动模式那样，主动的通过自己的20口连接客户端，而都是FTP客户端来连接FTP服务器自身，FTP服务器都是被动接受连接请求的**，所有成为FTP的被动连接

![FTP被动模式](http://obfs4iize.bkt.clouddn.com/FTP2.png)

从图中可以看出，两次连接都是FTP客户端向FTP服务器请求连接的，FTP服务器被动接收

用大白话再次解释一下FTP主动模式和FTP被动模式
FTP主动模式：FTP客户端告诉FTP服务端21端口，我要小黄片，我的端口是1024，然后FTP服务器将小黄片**主动**发送给FTP客户端

FTP被动模式：FTP客户端看完了一部，依旧饥渴难耐，再次向FTP服务端21端口发起连接请求，我还想要一部小黄片，此时FTP服务器觉得太麻烦了，老是要伺候FTP客户端，所以直接告诉FTP客户端，我已经打开了某某端口了，自己进去找苍老师

这样就应该清楚FTP主动和被动了

那么我自己就产生了几个问题：
1.主动模式的端口FTP服务器一定要21端口和20端口吗？
2.为何有了FTP主动模式的存在还要FTP被动模式？
3.FTP既然分模式，那这两种模式运用的场景是什么？

如果我说，这些问题就让你们自己去探索吧！那这就是一篇坑文！！

那我来一一解答一下
1.主动模式的端口FTP服务器一定要21端口和20端口吗？
这个当然是可以改的，但是你改了21端口（这个端口默认是承载命令流量的）你的数据流量端口（默认是20端口）就会自动改变，如你将21端口改为x，那么你的20端口就变为x-1

而且很多时候，为公司做FTP服务器映射时，也要注意这个

2.为何有了FTP主动模式的存在还要FTP被动模式？
查了一些，以前FTP只用主动模式，看到这里，就知道主动模式肯定有局限了，我所知道它有一个局限
一个是主动FTP穿越防火墙可能会发生故障，原因是什么呢？？
原因：
一般的人会对自己的企业防火墙做内部安全域（in域）的主机对外部Internet的访问和请求是允许的，当Internet上的Web或FTP服务器收到了in域的FTP客户端请求，就会回应它，当回应数据到达防火墙外部接口时，防火墙对其进行检查，发现数据流量是内部主动请求后由外部返回的流量，允许通过，**防火墙是允许内部主动发起，外部相应的流量的**，想想自己在网上冲浪，对网页界面的请求通过防火墙到达internet上的web服务器，web服务器返回数据，这些流量一般都有明显的特征，如SYN=1 ACK=1这个明显特征，默认情况下，防火墙会拒绝所有从外部**主动**链接到内部的流量，这是可以理解的，因为外部Internet网络环境复杂，是不受信任的，如果有恶意流量想要进入内部，就被阻止了

这里问题就来了，FTP主动模式时，FTP服务器会主动的向FTP客户端发起连接，如果FTP服务器是在外部的不受信任域（out域），而FTP客户端是在内部域（in域），那么FTP服务器主动请求的流量会被防火墙拒绝掉，那么FTP建立会失败！！！如图
![FTP穿越防火墙问题](http://obfs4iize.bkt.clouddn.com/FTP%E9%98%B2%E7%81%AB%E5%A2%99%E9%97%AE%E9%A2%98.png)

这里就需要FTP被动模式了，FTP主动模式的局限已经出来了，只要用FTP被动模式，那么所有的流量都是内部可信任域先发出的流量，防火墙就不会拦截了。

第二种方法，就是使用更加智能的防火墙，可以识别会话状态的状态防火墙

那么有人就说，这也可以说是防火墙的局限性，不一定要有FTP被动模式，我想说，状态防火墙当时没造出来

上网查FTP的资料时，发送很多人说做端口映射的时候，专业点就叫**NAT转换**或**PAT转换**的时候，FTP主动模式也是连不上的，因为IP地址变成公网地址了，但是以我现在所学到的知识，认为是可以连上的

简单解释一下NAT，因为IPv4地址不够用，那么很多计算机要上网是不会给你公网地址的，我们连接电信啊，移动啊，都是给你分配一个不固定的私网IP地址，私网IP是可以反复使用的，不像公网地址那样全球唯一，那么私网地址是不可路由的，那么就要将私网映射成公网地址，你可以用ipconfig来查看一下你自动私网地址，自己去google一下

![私网地址](http://obfs4iize.bkt.clouddn.com/%E7%A7%81%E7%BD%91%E5%9C%B0%E5%9D%80.png)
我映射后的公网地址
![公网地址](http://obfs4iize.bkt.clouddn.com/%E5%85%AC%E7%BD%91%E5%9C%B0%E5%9D%80.png)
比如我现在要上网，那么我的私网地址肯定通过运营商，将我的私网转换成了公网，这样既不要开销过多的公网地址，节约了IP，又可以上网，这就是NAT技术的目的，PAT可以理解为是NAT的进化版，可以用端口进行公网映射

NAT：192.168.1.103-----NAT----> 14.156.64.124
PAT：192.168.1.103:8888----PAT---->14.156.64.124:99
PAT可以根据节省IP，所有现在一般使用的都是PAT

那么问题来了，我们向FTP服务器请求一个小黄片，那么我的数据是从192.168.1.103的某个端口，如1024端口发出，经过PAT转换，FTP服务器收到就是14.156.64.124的2000端口要一个数据，FTP会主动向14.156.64.124的2000端口发送数据，此时PAT当然依旧会把14.156.64.124的2000端口转换回192.168.1.103的1024端口，其实我们上网，请求流量通过PAT转换为公网IP后在公网路由，找到公网上的web服务器，然后web在将信息发回给公网IP，这个流量再经过PAT转换回来，就可以浏览网页是一个道理。

3.FTP既然分模式，那这两种模式运用的场景是什么？

这就要看两种模式的局限，从而避免在有局限的场景使用，刚刚已经聊过FTP主动模式的局限了，那么FTP被动模式的局限

在使用ACL进行FTP数据过滤的时候，往往由于不能清晰的理解被动FTP模式的过程，忽略了被动FTP所使用的高端口号，而导致对FTP数据的识别和过滤失败

其实为了方便管理，可以将被动模式下，服务器的端口的取值范围改为20~20，这样服务器被动连接的端口就为20了，变得跟主动模式一样了，方便管理。（**被动模式中数据端口的范围是可以自定义的**）